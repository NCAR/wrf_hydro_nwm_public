# ---    
# --- NWM ESMF/NUOPC makefile 
# --- Requires ESMV V8+
# --- NWM ESMF component.
#

# ###############
# Local Variables
# ###############

HR    := ========================================
HR    := $(HR)$(HR)
COMMA := ,
DIR   := $(CURDIR)

# ###########################
# Include ESMFMKFILE fragment
# ###########################

ifneq ($(origin ESMFMKFILE), environment)
$(error Environment variable ESMFMKFILE was not set.)
endif
include $(ESMFMKFILE)

# #########################
# Determine Build Precision
# #########################

ifeq ($(BUILD_PREC),r4)
override ESMF_F90COMPILECPPFLAGS += -DREAL4
else ifeq ($(BUILD_PREC),r8)
override ESMF_F90COMPILECPPFLAGS += -DREAL8
else
override ESMF_F90COMPILECPPFLAGS += -DREAL4
endif

# #################################
# Compile with Debugging Directives
# #################################

ifeq ($(DEBUG),on)
override ESMF_F90COMPILECPPFLAGS += -DDEBUG
override ESMF_CXXCOMPILECPPFLAGS += -DDEBUG
endif

# ###########################
# Determine Installation Path
# ###########################

ifndef DESTDIR
DESTDIR  := $(DIR)
endif

ifndef INSTDIR
INSTDIR  := NWM_$(shell date '+%Y-%m-%d-%H-%M-%S')
endif

ifndef INSTPATH
INSTPATH := $(abspath $(DESTDIR)/$(INSTDIR))
endif

# ###############
# Model Variables
# ###############
#
ifndef NWM_DIR
MODEL_DIR    := $(abspath $(DIR)/../..)
else
MODEL_DIR    := $(abspath $(NWM_DIR))
endif
MODEL_LIB    := $(abspath $(MODEL_DIR)/lib/libHYDRO.a)
MODEL_OBJS   := ../../MPP/mpp_land.o ../../Land_models/NoahMP/IO_code/module_NoahMP_hrldas_driver.o ../../Land_models/NoahMP/IO_code/module_hrldas_netcdf_io.o ../../Data_Rec/module_namelist.o ../../CPL/NoahMP_cpl/hrldas_drv_HYDRO.o ../../CPL/NoahMP_cpl/module_hrldas_HYDRO.o ../../Data_Rec/module_RT_data.o ../../Routing/module_NWM_io_dict.o ../../Routing/Overland/module_overland_control.o ../../Routing/module_HYDRO_utils.o ../../Data_Rec/module_gw_gw2d_data.o ../../Land_models/NoahMP/Utility_routines/module_date_utilities.o ../../Routing/module_NWM_io.o ../../Debug_Utilities/debug_dump_variable.o ../../Land_models/NoahMP/Utility_routines/module_model_constants.o ../../Land_models/NoahMP/Utility_routines/module_wrf_utilities.o ../../Land_models/NoahMP/Utility_routines/kwm_string_utilities.o ../../Land_models/NoahMP/phys/module_sf_noahmplsm.o ../../Land_models/NoahMP/phys/module_sf_noahmp_glacier.o ../../Land_models/NoahMP/phys/module_sf_noahmp_groundwater.o ../../Land_models/NoahMP/phys/module_sf_noahmpdrv.o ../../MPP/module_mpp_ReachLS.o ../../MPP/module_mpp_GWBUCKET.o ../../Routing/module_channel_routing.o ../../Routing/module_gw_gw2d.o ../../Routing/module_lsm_forcing.o ../../Routing/Noah_distr_routing.o ../../Routing/module_date_utilities_rt.o ../../Routing/module_HYDRO_io.o ../../Routing/module_noah_chan_param_init_rt.o ../../Routing/module_reservoir_routing.o ../../Routing/Noah_distr_routing_overland.o ../../Routing/module_GW_baseflow.o ../../Routing/module_RT.o ../../Routing/Noah_distr_routing_subsurface.o ../../Routing/Overland/module_overland.o ../../Routing/Overland/module_overland_streams_and_lakes.o ../../Routing/Overland/module_overland_mass_balance.o ../../Routing/Overland/module_overland_routing_properties.o ../../Routing/Subsurface/module_subsurface_grid_transform.o ../../Routing/Subsurface/module_subsurface_output.o ../../Routing/Subsurface/module_subsurface_static_data.o ../../Routing/Subsurface/module_subsurface_input.o ../../Routing/Subsurface/module_subsurface_properties.o ../../Routing/Subsurface/module_subsurface.o ../../Routing/Subsurface/module_subsurface_state.o ../../Routing/Groundwater/module_groundwater_base.o ../../Routing/Groundwater/module_groundwater_static_data.o ../../Routing/Groundwater/module_UDMAP.o ../../utils/module_version.o 

# #############
# Cap Variables
# #############

CAP_DIR       := $(abspath $(DIR))
CAP_LIB       := libnwm_nuopc.a
CAP_DEP_FRONT := nwm_nuopc
CAP_VERS      := VERSION
CAP_MK        := nwm.mk
CAP_OBJS      := NWM_ESMF_Extensions.o NWM_NUOPC_Gluecode.o NWM_NUOPC_Cap.o
CAP_MODS      := nwm_esmf_extensions.mod nwm_nuopc_gluecode.mod nwm_nuopc_cap.mod
CAP_FILES     := $(CAP_OBJS) $(CAP_MODS)

# ##############
# Build Settings
# ##############

.SUFFIXES: 
.SUFFIXES: .c .C .f90 .F90 .F .f

.F:
	@echo "Must have an explicit rule for" $*
.f:
	@echo "Must have an explicit rule for" $*
.C:
	@echo "Must have an explicit rule for" $*
.c: 
	@echo "Must have an explicit rule for" $*

%.o : %.f90
	@echo $(HR)
	@echo "Compiling $@..."
	@echo
	$(ESMF_F90COMPILER) -c $(ESMF_F90COMPILEOPTS) $(ESMF_F90COMPILEPATHS) $(ESMF_F90COMPILEFREENOCPP) $<

%.o : %.F90
	@echo $(HR)
	@echo "Compiling $@..."
	@echo
	$(ESMF_F90COMPILER) -c $(ESMF_F90COMPILEOPTS) $(ESMF_F90COMPILEPATHS) $(ESMF_F90COMPILEFREECPP) $(ESMF_F90COMPILECPPFLAGS) -DESMF_VERSION_MAJOR=$(ESMF_VERSION_MAJOR) $<


# #######################
# Primary Makefile Target
# #######################

mainApp: mainApp.o driver.o NWM_ESMF_Extensions.o  NWM_NUOPC_Cap.o  NWM_NUOPC_Gluecode.o
	$(ESMF_F90LINKER) $(ESMF_F90LINKOPTS) $(ESMF_F90LINKPATHS) $(ESMF_F90LINKRPATHS) NWM_ESMF_Extensions.o NWM_NUOPC_Gluecode.o NWM_NUOPC_Cap.o driver.o mainApp.o -o $@ $^ ../../MPP/mpp_land.o ../../Land_models/NoahMP/IO_code/module_NoahMP_hrldas_driver.o ../../Land_models/NoahMP/IO_code/module_hrldas_netcdf_io.o ../../Data_Rec/module_namelist.o ../../CPL/NoahMP_cpl/hrldas_drv_HYDRO.o ../../CPL/NoahMP_cpl/module_hrldas_HYDRO.o ../../Data_Rec/module_RT_data.o ../../Routing/module_NWM_io_dict.o ../../Routing/Overland/module_overland_control.o ../../Routing/module_HYDRO_utils.o ../../Data_Rec/module_gw_gw2d_data.o ../../Land_models/NoahMP/Utility_routines/module_date_utilities.o ../../Routing/module_NWM_io.o ../../Debug_Utilities/debug_dump_variable.o ../../Land_models/NoahMP/Utility_routines/module_model_constants.o ../../Land_models/NoahMP/Utility_routines/module_wrf_utilities.o ../../Land_models/NoahMP/Utility_routines/kwm_string_utilities.o ../../Land_models/NoahMP/phys/module_sf_noahmplsm.o ../../Land_models/NoahMP/phys/module_sf_noahmp_glacier.o ../../Land_models/NoahMP/phys/module_sf_noahmp_groundwater.o ../../Land_models/NoahMP/phys/module_sf_noahmpdrv.o ../../MPP/module_mpp_ReachLS.o ../../MPP/module_mpp_GWBUCKET.o ../../Routing/module_channel_routing.o ../../Routing/module_gw_gw2d.o ../../Routing/module_lsm_forcing.o ../../Routing/Noah_distr_routing.o ../../Routing/module_date_utilities_rt.o ../../Routing/module_HYDRO_io.o ../../Routing/module_noah_chan_param_init_rt.o ../../Routing/module_reservoir_routing.o ../../Routing/Noah_distr_routing_overland.o ../../Routing/module_GW_baseflow.o ../../Routing/module_RT.o ../../Routing/Noah_distr_routing_subsurface.o ../../Routing/Overland/module_overland.o ../../Routing/Overland/module_overland_streams_and_lakes.o ../../Routing/Overland/module_overland_mass_balance.o ../../Routing/Overland/module_overland_routing_properties.o ../../Routing/Subsurface/module_subsurface_grid_transform.o ../../Routing/Subsurface/module_subsurface_output.o ../../Routing/Subsurface/module_subsurface_static_data.o ../../Routing/Subsurface/module_subsurface_input.o ../../Routing/Subsurface/module_subsurface_properties.o ../../Routing/Subsurface/module_subsurface.o ../../Routing/Subsurface/module_subsurface_state.o ../../Routing/Groundwater/module_groundwater_base.o ../../Routing/Groundwater/module_groundwater_static_data.o ../../Routing/Groundwater/module_UDMAP.o ../../utils/module_version.o $(ESMF_F90ESMFLINKLIBS) ../../lib/libHYDRO.a


# ############
# Dependencies
# ############
mainApp: driver.o
driver.o: NWM_NUOPC_Cap.o
NWM_NUOPC_Cap.o: NWM_NUOPC_Gluecode.o NWM_ESMF_Extensions.o

# ------------------------------------------------------------------
.PHONY: nuopc nuopcinstall nuopcdistclean nuopcclean install_mk

nuopc: 
	$(ESMF_F90COMPILER) -c $(ESMF_F90COMPILEOPTS) $(ESMF_F90COMPILEPATHS) $(ESMF_F90COMPILEFREECPP) $(ESMF_F90COMPILECPPFLAGS) -DESMF_VERSION_MAJOR=$(ESMF_VERSION_MAJOR) -I ../../Land_models/NoahMP/Utility_routines -I ../../Land_models/NoahMP/IO_code -I ../../Land_models/NoahMP/phys -I ../../MPP -I ../../Data_Rec -I ../../mod -I ../../HYDRO_drv NWM_ESMF_Extensions.F90
	$(ESMF_F90COMPILER) -c $(ESMF_F90COMPILEOPTS) $(ESMF_F90COMPILEPATHS) $(ESMF_F90COMPILEFREECPP) $(ESMF_F90COMPILECPPFLAGS) -DESMF_VERSION_MAJOR=$(ESMF_VERSION_MAJOR) -I ../../Land_models/NoahMP/Utility_routines -I ../../Land_models/NoahMP/IO_code -I ../../Land_models/NoahMP/phys -I ../../MPP -I ../../Data_Rec -I ../../mod -I ../../HYDRO_drv NWM_NUOPC_Gluecode.F90
	$(ESMF_F90COMPILER) -c $(ESMF_F90COMPILEOPTS) $(ESMF_F90COMPILEPATHS) $(ESMF_F90COMPILEFREECPP) $(ESMF_F90COMPILECPPFLAGS) -DESMF_VERSION_MAJOR=$(ESMF_VERSION_MAJOR) -I ../../Land_models/NoahMP/Utility_routines -I ../../Land_models/NoahMP/IO_code -I ../../Land_models/NoahMP/phys -I ../../MPP -I ../../Data_Rec -I ../../mod -I ../../HYDRO_drv NWM_NUOPC_Cap.F90
	$(ESMF_F90COMPILER) -c $(ESMF_F90COMPILEOPTS) $(ESMF_F90COMPILEPATHS) $(ESMF_F90COMPILEFREECPP) $(ESMF_F90COMPILECPPFLAGS) -DESMF_VERSION_MAJOR=$(ESMF_VERSION_MAJOR) -I ../../Land_models/NoahMP/Utility_routines -I ../../Land_models/NoahMP/IO_code -I ../../Land_models/NoahMP/phys -I ../../MPP -I ../../Data_Rec -I ../../mod -I ../../HYDRO_drv driver.F90
	$(ESMF_F90COMPILER) -c $(ESMF_F90COMPILEOPTS) $(ESMF_F90COMPILEPATHS) $(ESMF_F90COMPILEFREECPP) $(ESMF_F90COMPILECPPFLAGS) -DESMF_VERSION_MAJOR=$(ESMF_VERSION_MAJOR) -I ../../Land_models/NoahMP/Utility_routines -I ../../Land_models/NoahMP/IO_code -I ../../Land_models/NoahMP/phys -I ../../MPP -I ../../Data_Rec -I ../../mod -I ../../HYDRO_drv mainApp.F90
	$(ESMF_F90LINKER) $(ESMF_F90LINKOPTS) $(ESMF_F90LINKPATHS) $(ESMF_F90LINKRPATHS) NWM_ESMF_Extensions.o NWM_NUOPC_Gluecode.o NWM_NUOPC_Cap.o driver.o mainApp.o -o $@ $^ ../../MPP/mpp_land.o ../../Land_models/NoahMP/IO_code/module_NoahMP_hrldas_driver.o ../../Land_models/NoahMP/IO_code/module_hrldas_netcdf_io.o ../../Data_Rec/module_namelist.o ../../CPL/NoahMP_cpl/hrldas_drv_HYDRO.o ../../CPL/NoahMP_cpl/module_hrldas_HYDRO.o ../../Data_Rec/module_RT_data.o ../../Routing/module_NWM_io_dict.o ../../Routing/Overland/module_overland_control.o ../../Routing/module_HYDRO_utils.o ../../Data_Rec/module_gw_gw2d_data.o ../../Land_models/NoahMP/Utility_routines/module_date_utilities.o ../../Routing/module_NWM_io.o ../../Debug_Utilities/debug_dump_variable.o ../../Land_models/NoahMP/Utility_routines/module_model_constants.o ../../Land_models/NoahMP/Utility_routines/module_wrf_utilities.o ../../Land_models/NoahMP/Utility_routines/kwm_string_utilities.o ../../Land_models/NoahMP/phys/module_sf_noahmplsm.o ../../Land_models/NoahMP/phys/module_sf_noahmp_glacier.o ../../Land_models/NoahMP/phys/module_sf_noahmp_groundwater.o ../../Land_models/NoahMP/phys/module_sf_noahmpdrv.o ../../MPP/module_mpp_ReachLS.o ../../MPP/module_mpp_GWBUCKET.o ../../Routing/module_channel_routing.o ../../Routing/module_gw_gw2d.o ../../Routing/module_lsm_forcing.o ../../Routing/Noah_distr_routing.o ../../Routing/module_date_utilities_rt.o ../../Routing/module_HYDRO_io.o ../../Routing/module_noah_chan_param_init_rt.o ../../Routing/module_reservoir_routing.o ../../Routing/Noah_distr_routing_overland.o ../../Routing/module_GW_baseflow.o ../../Routing/module_RT.o ../../Routing/Noah_distr_routing_subsurface.o ../../Routing/Overland/module_overland.o ../../Routing/Overland/module_overland_streams_and_lakes.o ../../Routing/Overland/module_overland_mass_balance.o ../../Routing/Overland/module_overland_routing_properties.o ../../Routing/Subsurface/module_subsurface_grid_transform.o ../../Routing/Subsurface/module_subsurface_output.o ../../Routing/Subsurface/module_subsurface_static_data.o ../../Routing/Subsurface/module_subsurface_input.o ../../Routing/Subsurface/module_subsurface_properties.o ../../Routing/Subsurface/module_subsurface.o ../../Routing/Subsurface/module_subsurface_state.o ../../Routing/Groundwater/module_groundwater_base.o ../../Routing/Groundwater/module_groundwater_static_data.o ../../Routing/Groundwater/module_UDMAP.o ../../utils/module_version.o $(ESMF_F90ESMFLINKLIBS) ../../lib/libHYDRO.a



nuopcinstall: $(CAP_LIB) $(CAP_MODS) $(CAP_VERS) \
 $(addprefix $(INSTPATH)/,$(CAP_LIB)) \
 $(addprefix $(INSTPATH)/,$(CAP_MODS)) \
 $(addprefix $(INSTPATH)/,$(CAP_VERS)) \
 install_mk


# #####################
# Build NUOPC Component
# #####################

$(CAP_LIB): $(MODEL_LIB) $(CAP_OBJS) $(MODEL_OBJS)
	@echo $(HR)
	@echo "Creating static library $@..."
	$(call checkfile, $(MODEL_LIB))
	cp $(MODEL_LIB) $@
	ar cr $@ $(CAP_OBJS) $(CAP_MOD) $(MODEL_OBJS)

$(CAP_VERS):
	@echo $(HR)
	@echo "Generating Version Information"
	@echo
	@echo "# NUOPC Cap Version" > $(CAP_VERS)
	@if [ -d .svn ]; then \
	  echo "SVN Repository" > $(CAP_VERS); \
	  svn info . | grep URL >> $(CAP_VERS); \
	  svn info . | grep "Last Changed Rev" >> $(CAP_VERS); \
	elif [ -d .git ]; then \
	  echo "Git Repository" > $(CAP_VERS); \
	  git show . | grep -m 1 "commit " >> $(CAP_VERS); \
	  git show . | grep -m 1 "Author: " >> $(CAP_VERS); \
	  git show . | grep -m 1 "Date: " >> $(CAP_VERS); \
	fi

$(CAP_MK): 
	@echo $(HR)
	@echo "Generating NUOPC Makefile Fragment"
	@echo
	@echo "# ESMF self-describing build dependency makefile fragment" > $(CAP_MK)
	@echo "" >> $(CAP_MK)
	@echo "ESMF_DEP_FRONT     = $(CAP_DEP_FRONT)" >> $(CAP_MK)
	@echo "ESMF_DEP_INCPATH   = $(CAP_DIR)" >> $(CAP_MK)
	@echo "ESMF_DEP_CMPL_OBJS = " >> $(CAP_MK)
	@echo "ESMF_DEP_LINK_OBJS = $(CAP_DIR)/$(CAP_LIB)" >> $(CAP_MK)
	@echo "ESMF_DEP_SHRD_PATH = " >> $(CAP_MK)
	@echo "ESMF_DEP_SHRD_LIBS = " >> $(CAP_MK)

# -----------------------------------------------------------------------------
# Install Library, Modules, and Makefile Fragment
# -----------------------------------------------------------------------------

$(INSTPATH)/%:
	@echo $(HR)
	@echo "Installing $(notdir $@)"
	@echo
	@mkdir -p $(INSTPATH)
	cp $(notdir $@) $@

install_mk: 
	@echo $(HR)
	@echo "Installing NUOPC Makefile Fragment"
	@echo
	@mkdir -p $(INSTPATH)
	@echo "# ESMF self-describing build dependency makefile fragment" > $(INSTPATH)/$(CAP_MK)
	@echo "" >> $(INSTPATH)/$(CAP_MK)
	@echo "ESMF_DEP_FRONT     = $(CAP_DEP_FRONT)" >> $(INSTPATH)/$(CAP_MK)
	@echo "ESMF_DEP_INCPATH   = $(INSTPATH)" >> $(INSTPATH)/$(CAP_MK)
	@echo "ESMF_DEP_CMPL_OBJS = " >> $(INSTPATH)/$(CAP_MK)
	@echo "ESMF_DEP_LINK_OBJS = $(INSTPATH)/$(CAP_LIB)" >> $(INSTPATH)/$(CAP_MK)
	@echo "ESMF_DEP_SHRD_PATH = " >> $(INSTPATH)/$(CAP_MK)
	@echo "ESMF_DEP_SHRD_LIBS = " >> $(INSTPATH)/$(CAP_MK)

# ###########
# Check Build
# ###########

define checkfile
	@if [ ! -e $(1) ]; then \
	echo "File is missing:$(1)"; \
	exit 1; fi;

endef # blank line in checkfile is required

define checkdir
	@if [ ! -d $(1) ]; then \
	echo "Directory is missing:$(1)"; \
	exit 1; fi;
endef # blank line in checkdir is required

check: check_esmf check_model check_cap

# ##################
# Check ESMF Version
# ##################

check_esmf:
	@echo $(HR)
	@echo "Checking ESMFMKFILE file..."
	@echo
	@echo "ESMFMKFILE=$(ESMFMKFILE)"
	@if [ "$(ESMF_VERSION_MAJOR)" -lt 8 ]; then \
	echo "Please use ESMF version 8+"; \
	exit 1; fi;
	@echo "ESMF Version=$(ESMF_VERSION_STRING)"

# ###########
# Check Model
# ###########

check_model:
	@echo $(HR)
	@echo "Checking for Model files..."
	@echo
	$(foreach FILENAME, $(MODEL_FILES), $(call checkfile, $(FILENAME)))

# #########
# Check Cap
# #########

check_cap: 
	@echo $(HR)
	@echo "Checking for NWM NUOPC files..."
	@echo
	$(foreach FILENAME, $(CAP_FILES), $(call checkfile, $(FILENAME)))

# ###################
# Clean Cap and Model
# ###################

nuopcdistclean: nuopcclean
	@echo $(HR)
	@echo "Cleaning Model build..."
	@echo ""
	$(call checkdir, $(MODEL_DIR))
	make -C $(MODEL_DIR) -f $(MODEL_MK) clean

# #########
# Clean Cap
# #########

nuopcclean:
	@echo $(HR)
	@echo "Cleaning Cap build..."
	@echo
	rm -f $(CAP_FILES) $(CAP_MK) $(CAP_LIB) 

# ------------------------------------------------------------------------------
